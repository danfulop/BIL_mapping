---
title: "BIL_phenotypic_clustering"
author: "Daniel Fulop"
date: "July 21, 2014"
output:
  html_document:
    fig_height: 7
    fig_width: 10
    keep_md: yes
---

## Clustering analysis strategy

- Model each trait with an LMM using lme4
  * Estimate a mean value for each trait for each BIL, adding coefficient estimates from lme4

- Use the estimated means for:
  * QTL Mapping
    * with SparseNet, w/ and w/o 2-locus epistasis

- Clustering with pdfCluster (density modes) and other methods as well (e.g. dissimilarity)


## All complexity
```{r, echo=FALSE, message=FALSE, results='hide', warning=FALSE}
library(lme4)
library(ggplot2)
library(coefplot2)
setwd("/Users/Dani/UCD/BILs/leaf_traits/") ## Change to the directory to which you saved the data files
# load data tables
comp <- read.delim("BIL.complexity.all.2011.txt")
head(comp)  
summary(comp)
nlevels(comp$genotype) # 545
comp$block <- as.factor(substr(comp$plant,1,1)) # capture block information from the plant ID
head(comp$genotype)
levels(comp$genotype)
comp.rn <- comp
comp.rn$genotype <- as.character(comp.rn$genotype)

load("~/UCD/BILs/bil.reassign.Rdata") ##** Load bil.reassign, which is generated by bin_classif.R script.
comp.rn <- merge(comp.rn, bil.reassign, by.x="genotype", by.y="BIL") # merge by original BIL# assignment
head(comp.rn)
as.factor(comp.rn$genotype)
comp.rn$FinBIL <- as.factor(comp.rn$FinBIL)
levels(comp.rn$FinBIL)
comp.rn$FinBIL<- relevel(comp.rn$FinBIL, "M82")
#
all.x <- lmer(all ~ FinBIL + (1|block) + (1|plant), comp.rn, REML=T)
all.x  
fixef(all.x)

class(coeftab(all.x))
ct <- as.data.frame(coeftab(all.x))
summary(ct)
head(ct)
rownames(ct)[1] <- "M82"
head(ct)
ct$geno <- rownames(ct)
ct$geno[2:nrow(ct)] <- substr(ct$geno[2:nrow(ct)],7,13)
ct$geno
head(ct)
# convert from coefficient table to "prediction" table

ct[2:nrow(ct),1] <- ct[2:nrow(ct),1] + ct[1,1] # i.e. add the intercept estimate to the genotype coefficients' estimates 
ct[2:nrow(ct),3:6] <- ct[2:nrow(ct),3:6] + ct[1,1] # ...and also add the intercept to the quantile estimates of the genotype coefficients
head(ct)
ct$estPse <- ct$Estimate + ct[,2] # estimate + std err -- calculate upper error bar limit
ct$estMse<- ct$Estimate - ct[,2] # estimate - std err -- calculate lower error bar limit
head(ct)
#ct[,1:6] <- as.numeric(ct[,1:6])
class(ct$estPse)
class(ct)
names(ct)[2] <- 'Std._Error'
summary(ct)
ct <- ct[with(ct, order(Estimate)), ]
head(ct)
ctp <- ct
ctp$geno <- factor(ctp$geno, levels=ctp$geno)
# Plot the whole distribution of predicted genotype effects on "all" complexity counts
ggplot(ctp, aes(y=Estimate, x=geno, ymin=Estimate - Std._Error, ymax=Estimate + Std._Error)) + geom_pointrange() + theme_bw() +
  theme(axis.text.x = element_text(size=3.5, angle=50, vjust=1, hjust=1))

head(ct)
head(comp.rn)
summary(comp.rn)
ctall <- ct
ctall$type <- 'all'
head(ctall)
#save(ctall, file="/Users/Dani/UCD/BILs/leaf_traits/ctall.Rdata")
```

## Primary complexity

```{r, echo=FALSE, message=FALSE, results='hide', warning=FALSE}
mpri <- lmer(pri ~ FinBIL + (1|block) + (1|plant), comp.rn, REML=F)
ctpri <- as.data.frame(coeftab(mpri))

summary(ctpri)
head(ctpri)
rownames(ctpri)[1] <- "M82"
head(ctpri)
ctpri$geno <- rownames(ctpri)
ctpri$geno[2:nrow(ctpri)] <- substr(ctpri$geno[2:nrow(ctpri)],7,13)
ctpri$geno
head(ctpri)
# convert from coefficient table to "prediction" table

ctpri[2:nrow(ctpri),1] <- ctpri[2:nrow(ctpri),1] + ctpri[1,1]
ctpri[2:nrow(ctpri),3:6] <- ctpri[2:nrow(ctpri),3:6] + ctpri[1,1]
head(ctpri)
ctpri$estPse <- ctpri$Estimate + ctpri[,2] # estimate + std err
ctpri$estMse<- ctpri$Estimate - ctpri[,2] # estimate - std err 
head(ctpri)
#ctpri[,1:6] <- as.numeric(ctpri[,1:6])
class(ctpri$estPse)
class(ctpri)
names(ctpri)[2] <- 'Std._Error'
summary(ctpri)
ctpri <- ctpri[with(ctpri, order(Estimate)), ]
head(ctpri)
ctpri$type <- 'primary'

ctp <- ctpri
ctp$geno <- factor(ctp$geno, levels=ctp$geno)
# Plot the whole distribution of predicted genotype effects on "all" complexity counts
ggplot(ctp, aes(y=Estimate, x=geno, ymin=Estimate - Std._Error, ymax=Estimate + Std._Error)) + geom_pointrange() + theme_bw() +
  theme(axis.text.x = element_text(size=3.5, angle=50, vjust=1, hjust=1))
```

## Intercallary complexity

```{r, echo=FALSE, message=FALSE, results='hide', warning=FALSE}

mint <- lmer(int ~ FinBIL + (1|block) (1|plant), comp.rn, REML=F)
ctint <- as.data.frame(coeftab(mint))

summary(ctint)
head(ctint)
rownames(ctint)[1] <- "M82"
head(ctint)
ctint$geno <- rownames(ctint)
ctint$geno[2:nrow(ctint)] <- substr(ctint$geno[2:nrow(ctint)],7,13)
ctint$geno
head(ctint)
# convert from coefficient table to "prediction" table

ctint[2:nrow(ctint),1] <- ctint[2:nrow(ctint),1] + ctint[1,1]
ctint[2:nrow(ctint),3:6] <- ctint[2:nrow(ctint),3:6] + ctint[1,1]
head(ctint)
ctint$estPse <- ctint$Estimate + ctint[,2] # estimate + std err
ctint$estMse<- ctint$Estimate - ctint[,2] # estimate - std err 
head(ctint)
#ctint[,1:6] <- as.numeric(ctint[,1:6])
class(ctint$estPse)
class(ctint)
names(ctint)[2] <- 'Std._Error'
summary(ctint)
ctint <- ctint[with(ctint, order(Estimate)), ]
head(ctint)
ctint$type <- 'intercallary'

ctp <- ctint
ctp$geno <- factor(ctp$geno, levels=ctp$geno)
# Plot the whole distribution of predicted genotype effects on "all" complexity counts
ggplot(ctp, aes(y=Estimate, x=geno, ymin=Estimate - Std._Error, ymax=Estimate + Std._Error)) + geom_pointrange() + theme_bw() +
  theme(axis.text.x = element_text(size=3.5, angle=50, vjust=1, hjust=1))
```

## Secondary complexity

```{r, echo=FALSE, message=FALSE, results='hide', warning=FALSE}

msec <- lmer(sec ~ FinBIL + (1|block) + (1|plant), comp.rn, REML=F)
ctsec <- as.data.frame(coeftab(msec))

summary(ctsec)
head(ctsec)
rownames(ctsec)[1] <- "M82"
head(ctsec)
ctsec$geno <- rownames(ctsec)
ctsec$geno[2:nrow(ctsec)] <- substr(ctsec$geno[2:nrow(ctsec)],7,13)
ctsec$geno
head(ctsec)
# convert from coefficient table to "prediction" table

ctsec[2:nrow(ctsec),1] <- ctsec[2:nrow(ctsec),1] + ctsec[1,1]
ctsec[2:nrow(ctsec),3:6] <- ctsec[2:nrow(ctsec),3:6] + ctsec[1,1]
head(ctsec)
ctsec$estPse <- ctsec$Estimate + ctsec[,2] # estimate + std err
ctsec$estMse<- ctsec$Estimate - ctsec[,2] # estimate - std err 
head(ctsec)
#ctsec[,1:6] <- as.numeric(ctsec[,1:6])
class(ctsec$estPse)
class(ctsec)
names(ctsec)[2] <- 'Std._Error'
summary(ctsec)
ctsec <- ctsec[with(ctsec, order(Estimate)), ]
head(ctsec)
ctsec$type <- 'secondary'
dim(ctsec)

ctp <- ctsec
ctp$geno <- factor(ctp$geno, levels=ctp$geno)
# Plot the whole distribution of predicted genotype effects on "all" complexity counts
ggplot(ctp, aes(y=Estimate, x=geno, ymin=Estimate - Std._Error, ymax=Estimate + Std._Error)) + geom_pointrange() + theme_bw() +
  theme(axis.text.x = element_text(size=3.5, angle=50, vjust=1, hjust=1))
```


```{r, echo=FALSE, message=FALSE, results='hide', warning=FALSE}
## NOTE: in this code chunk I'm joining together the parts of the data that will make up the data matrix for clustering
## 
library(plyr)
library(reshape2)
cEst <- join_all(list(ctpri[,c(1,7,10)], ctint[,c(1,7,10)], ctsec[,c(1,7,10)], ctall[,c(1,7,10)]), by=c('geno','type') , type='full')
cEst 
#summary(cEst)
cEst$geno <- as.factor(cEst$geno)
cEst$type <- as.factor(cEst$type)
summary(cEst)
rownames(cEst) <- paste0(cEst$geno,"_",cEst$type)
head(cEst)
tail(cEst)
dim(cEst)
cEst$ID <- rownames(cEst)



ce.noM82 <- cEst[cEst$geno!="M82",]
dim(ce.noM82)
head(ce.noM82)
ceo <- arrange(ce.noM82, geno, type)
head(ceo)
unique(ceo$geno)

cldat <- data.frame(primary=ceo[ceo$type=="primary",1], intercallary=ceo[ceo$type=="intercallary",1], secondary=ceo[ceo$type=="secondary",1], all=ceo[ceo$type=="all",1])
head(cldat)
rownames(cldat) <- unique(ceo$geno)
head(cldat)
```

## Clustering 1a -- density peak clustering

- With 4 complexity traits we only have a single peak/mode in the density

```{r, echo=FALSE, message=FALSE, results='hide', warning=FALSE}

library(pdfCluster) # density clustering, where the number of modes/peaks in the multidimensional joint trait distribution
cl.ct <- pdfCluster(cldat, graphtype="delaunay", full=TRUE)
cl.ct
pairs(cldat)
```

## Clustering 1b -- bayesian estimate of the number of clusters and cluster assignment; using dissimilarity matrix

```{r, echo=FALSE, message=FALSE, results='hide', warning=FALSE}

library(bayesclust) # bayesian estimate of the number of clusters and cluster assignment
clmat <- as.matrix(cldat)
dim(clmat)
cl.cat_baycl <- cluster.optimal(clmat, p=4)
cl.cat_baycl
plot(cl.cat_baycl)
cl.bay.cat <- cl.cat_baycl$data1$clusters[1,]
cldat.cat <- cbind(cldat, cl.bay.cat)
cldat.cat
cldat.cat$cl.bay.cat <- as.factor(cldat.cat$cl.bay.cat)
ggplot(cldat.cat) + geom_point(aes(x=primary, y=intercallary, color=cl.bay.cat)) + theme_gray(18)
```

## Clustering 2

```{r, echo=FALSE, message=FALSE, results='hide', warning=FALSE}
ggplot(cldat.cat) + geom_point(aes(x=primary, y=secondary, color=cl.bay.cat)) + theme_gray(18)
```

## Clustering 3

```{r, echo=FALSE, message=FALSE, results='hide', warning=FALSE}
ggplot(cldat.cat) + geom_point(aes(x=primary, y=all, color=cl.bay.cat)) + theme_gray(18)
```

## Clustering 4

```{r, echo=FALSE, message=FALSE, results='hide', warning=FALSE}
ggplot(cldat.cat) + geom_point(aes(x=secondary, y=intercallary, color=cl.bay.cat)) + theme_gray(18)
```

## Clustering 5

```{r, echo=FALSE, message=FALSE, results='hide', warning=FALSE}
ggplot(cldat.cat) + geom_point(aes(x=secondary, y=all, color=cl.bay.cat)) + theme_gray(18)
```

## Clustering 6

```{r, echo=FALSE, message=FALSE, results='hide', warning=FALSE}
ggplot(cldat.cat) + geom_point(aes(x=intercallary, y=all, color=cl.bay.cat)) + theme_gray(18)
## Plot in 3D, i.e. in dot-plots w/ the cluster classif. on it.
library(plot3D)
?scatter3D
```

## Clustering 7

```{r, echo=FALSE, message=FALSE, results='hide', warning=FALSE}
scatter3D(cldat.cat$primary, cldat.cat$intercallary, cldat.cat$secondary, colvar=cl.bay.cat, pch = 1, cex = 0.5, phi=20, theta=60) 
```

## Clustering 8

```{r, echo=FALSE, message=FALSE, results='hide', warning=FALSE}
scatter3D(cldat.cat$primary, cldat.cat$intercallary, cldat.cat$secondary, colvar=cl.bay.cat, pch = 1, cex = 0.5, phi=0, theta=70) 
```

## Clustering 9

```{r, echo=FALSE, message=FALSE, results='hide', warning=FALSE}
scatter3D(cldat.cat$primary, cldat.cat$intercallary, cldat.cat$secondary, colvar=cl.bay.cat, pch = 1, cex = 0.5, phi=40, theta=40) 
```

## Clustering 10

```{r, echo=FALSE, message=FALSE, results='hide', warning=FALSE}

scatter3D(cldat.cat$primary, cldat.cat$all, cldat.cat$secondary, colvar=cl.bay.cat, pch = 1, cex = 0.5, phi=20, theta=60)
```

## Clustering 11

```{r, echo=FALSE, message=FALSE, results='hide', warning=FALSE}
scatter3D(cldat.cat$primary, cldat.cat$secondary, cldat.cat$all, colvar=cl.bay.cat, pch = 1, cex = 0.5, phi=20, theta=60)
# PLOT w/ ggpairs AND cluster# ID
# library(GGally)
# summary(cldat.cat)
# ggpairs(cldat.cat, 1:4, color=cl.bay.cat)

# library(rgl) # allows movies of 3D plots rotating, etc.

## Loop through other data tables
##    Get lmm estimates
##    join estimates into 1 d.f.
##    cluster w/ several techniques
```
